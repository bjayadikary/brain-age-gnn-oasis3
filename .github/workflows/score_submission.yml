name: Score Submission

on:
  pull_request:
    paths:
      - 'submissions/**'
      - '!submissions/README.md'
      - '!submissions/encrypt_submission.py'

jobs:
  evaluate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install pandas scikit-learn pyyaml pycryptodome

      - name: Run Evaluation
        id: eval_step
        env:
          TEST_LABELS: ${{ secrets.TEST_LABELS }}
          RSA_PRIVATE_KEY: ${{ secrets.RSA_PRIVATE_KEY }}
        run: |
          # 1. Find the .enc file
          SUBMISSION_FILE=$(find submissions -name "*.enc" | head -n 1)
          
          if [ -z "$SUBMISSION_FILE" ]; then
            echo "ERROR: No encrypted (.enc) submission file found."
            exit 1
          fi

          # 2. Extract Team Name (folder name)
          TEAM_NAME=$(basename $(dirname "$SUBMISSION_FILE"))
          echo "team_name=$TEAM_NAME" >> $GITHUB_OUTPUT

          # 3. Run evaluation script
          python competition/evaluate.py --file "$SUBMISSION_FILE" | tee evaluation_output.txt

          # 4. Extract score
          SCORE=$(grep "SCORE_MAE" evaluation_output.txt | awk '{print $2}')
          echo "score=$SCORE" >> $GITHUB_OUTPUT

      - name: Update Leaderboard Files
        if: steps.eval_step.outputs.score != ''
        run: |
          TEAM="${{ steps.eval_step.outputs.team_name }}"
          SCORE="${{ steps.eval_step.outputs.score }}"
          # Capture current time in UTC
          SUBMISSION_TIME=$(date -u +"%b %d, %H:%M UTC")

          # 1. Update CSV (Database)
          if [ ! -f leaderboard.csv ]; then
            echo "team,mae,date" > leaderboard.csv
          fi
          echo "$TEAM,$SCORE,$SUBMISSION_TIME" >> leaderboard.csv
          
          # Sort CSV by MAE (ascending) and keep only the best score per team
          sort -t, -k2 -g leaderboard.csv | awk -F, '!seen[$1]++' > leaderboard.tmp && mv leaderboard.tmp leaderboard.csv

          # 2. Update Markdown (Summary)
          echo "# üèÜ Competition Leaderboard" > LEADERBOARD.md
          echo "Last updated: $SUBMISSION_TIME" >> LEADERBOARD.md
          echo "" >> LEADERBOARD.md
          echo "| Rank | Team | MAE Score | Submission Time |" >> LEADERBOARD.md
          echo "|------|------|-----------|-----------------|" >> LEADERBOARD.md
          awk -F, 'NR>1 {print "| " NR-1 " | " $1 " | " $2 " | " $3 " |"}' leaderboard.csv >> LEADERBOARD.md

          # 3. Inject into HTML using Python
          python3 -c "
          import pandas as pd
          import re
          
          df = pd.read_csv('leaderboard.csv').sort_values('mae')
          
          html_rows = ''
          for i, row in enumerate(df.itertuples(), 1):
              rank = f'{i}th'
              if i == 1: rank = 'ü•á 1st'
              elif i == 2: rank = 'ü•à 2nd'
              elif i == 3: rank = 'ü•â 3rd'
              
              html_rows += (
                  f'<tr>'
                  f'<td>{rank}</td>'
                  f'<td>{row.team}</td>'
                  f'<td class=\"mae-value\">{float(row.mae):.4f}</td>'
                  f'<td class=\"time-cell\">{row.date}</td>'
                  f'</tr>\n'
              )
          
          with open('leaderboard.html', 'r') as f:
              content = f.read()
          
          # Replace Table Body
          content = re.sub(r'.*?', 
                           f'\n{html_rows}', 
                           content, flags=re.DOTALL)
          
          # Replace Date Badge
          new_badge = f'\n<div class=\"badge bg-primary mt-2\">Last Updated: {SUBMISSION_TIME}</div>\n'
          content = re.sub(r'.*?', new_badge, content, flags=re.DOTALL)
          
          with open('leaderboard.html', 'w') as f:
              f.write(content)
          "

          # 4. Push changes back to main
          git config user.name "Leaderboard Bot"
          git config user.email "actions@github.com"
          git add leaderboard.csv LEADERBOARD.md leaderboard.html
          git commit -m "Update leaderboard: $TEAM ($SCORE)"
          git push origin HEAD:main

      - name: Post Score to Pull Request
        uses: mshick/add-pr-comment@v2
        if: always()
        with:
          message: |
            ## üß† Brain-Age GNN Result
            
            **Status:** ${{ steps.eval_step.outputs.score != '' && '‚úÖ Success' || '‚ùå Evaluation Failed' }}
            **Team:** `${{ steps.eval_step.outputs.team_name }}`
            **Metric:** Mean Absolute Error (MAE)
            **Your Score:** `${{ steps.eval_step.outputs.score || 'N/A' }}`
            
            *The leaderboard has been updated. Check [leaderboard.html](./leaderboard.html) for rankings!*