name: Score Submission

on:
  pull_request:
    paths:
      - 'submissions/**'
      - '!submissions/README.md'
      - '!submissions/encrypt_submission.py'

jobs:
  evaluate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install pandas scikit-learn pyyaml pycryptodome

      - name: Run Evaluation
        id: eval_step
        env:
          TEST_LABELS: ${{ secrets.TEST_LABELS }}
          RSA_PRIVATE_KEY: ${{ secrets.RSA_PRIVATE_KEY }}
        run: |
          # 1. Find the .enc file in the submissions folder
          SUBMISSION_FILE=$(find submissions -name "*.enc" | head -n 1)
          
          if [ -z "$SUBMISSION_FILE" ]; then
            echo "ERROR: No encrypted (.enc) submission file found."
            exit 1
          fi
          
          # 2. Run the evaluation script
          # The script now handles decryption internally using the RSA_PRIVATE_KEY env var
          python competition/evaluate.py --file "$SUBMISSION_FILE" | tee evaluation_output.txt
          
          # 3. Extract the score
          SCORE=$(grep "SCORE_MAE" evaluation_output.txt | awk '{print $2}')
          echo "score=$SCORE" >> $GITHUB_OUTPUT

      - name: Post Score to Pull Request
        uses: mshick/add-pr-comment@v2
        if: always()
        with:
          message: |
            ## üß† Brain-Age GNN Result
            
            **Status:** ${{ steps.eval_step.outputs.score != '' && '‚úÖ Success' || '‚ùå Evaluation Failed' }}
            **Metric:** Mean Absolute Error (MAE)
            **Your Score:** `${{ steps.eval_step.outputs.score || 'N/A' }}`
            
            *Note: If the score is N/A, please check the Action logs for decryption or validation errors.*