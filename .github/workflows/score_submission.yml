name: Score Submission

on:
  push:
    branches:
      - main
    paths:
      - 'submissions/**'
      - '!submissions/README.md'
  pull_request:
    paths:
      - 'submissions/**'
      - '!submissions/README.md'

jobs:
  evaluate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install pandas scikit-learn pyyaml pycryptodome

      - name: Run Evaluation
        id: eval_step
        env:
          TEST_LABELS: ${{ secrets.TEST_LABELS }}
          RSA_PRIVATE_KEY: ${{ secrets.RSA_PRIVATE_KEY }}
        run: |
          # 1. Get the path of the .enc file specifically from this PR/Push
          # This avoids picking up old folders like 'test_submission_6'
          SUBMISSION_FILE=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'submissions/.*\.enc$' | head -n 1)
          
          # 2. Fallback: If git diff is empty (like on a first push), use the find method
          if [ -z "$SUBMISSION_FILE" ]; then
            SUBMISSION_FILE=$(find submissions -name "*.enc" | head -n 1)
          fi
          
          if [ -z "$SUBMISSION_FILE" ]; then echo "ERROR: No submission file found"; exit 1; fi
          
          # 3. Extract Team Name from the folder containing the file
          TEAM_NAME=$(basename $(dirname "$SUBMISSION_FILE"))
          
          echo "Processing submission for team: $TEAM_NAME"
          
          # 4. Run evaluation
          python competition/evaluate.py --file "$SUBMISSION_FILE" | tee evaluation_output.txt
          
          # 5. Extract score
          SCORE=$(grep "SCORE_MAE" evaluation_output.txt | awk '{print $2}')
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "team_name=$TEAM_NAME" >> $GITHUB_OUTPUT

      - name: Post Score to PR
        # This ONLY runs on the Pull Request (Review Phase)
        if: github.event_name == 'pull_request'
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ## ðŸ§  Brain-Age GNN Submission Result
            **Team:** `${{ steps.eval_step.outputs.team_name }}`
            **Score (MAE):** `${{ steps.eval_step.outputs.score || 'Error Computing Score' }}`
            
            ---
            *Note: The leaderboard will only be updated once a maintainer merges this Pull Request.*

      - name: Update Leaderboard (Merge Phase)
        # This ONLY runs when the code is pushed/merged to main
        if: github.event_name == 'push' && steps.eval_step.outputs.score != ''
        run: |
          TEAM="${{ steps.eval_step.outputs.team_name }}"
          SCORE="${{ steps.eval_step.outputs.score }}"
          mkdir -p leaderboard
          
          # CSV Update Logic
          if [ ! -f leaderboard/leaderboard.csv ]; then echo "Rank,Team,MAE" > leaderboard/leaderboard.csv; fi
          echo "0,$TEAM,$SCORE" >> leaderboard/leaderboard.csv
          
          python3 -c "
          import pandas as pd
          df = pd.read_csv('leaderboard/leaderboard.csv')
          
          # Force column names to be lowercase to avoid KeyError
          df.columns = [c.lower() for c in df.columns]
          
          # Use 'mae' and 'team' (lowercase)
          df['mae'] = pd.to_numeric(df['mae'], errors='coerce')
          df = df.dropna(subset=['mae']).sort_values('mae').drop_duplicates('team', keep='first')
          
          # Re-assign Ranks and capitalize for the final save if you prefer
          df['rank'] = range(1, len(df) + 1)
          df.columns = [c.capitalize() for c in df.columns]
          df.to_csv('leaderboard/leaderboard.csv', index=False)
          "
          
          # Markdown Generation
          echo "# ðŸ† Competition Leaderboard" > leaderboard/LEADERBOARD.md
          echo "Last updated: $(date -u)" >> leaderboard/LEADERBOARD.md
          echo -e "\n| Rank | Team | MAE Score |\n|------|------|-----------|" >> leaderboard/LEADERBOARD.md
          tail -n +2 leaderboard/leaderboard.csv | awk -F, '{printf "| %s | %s | %s |\n", $1, $2, $3}' >> leaderboard/LEADERBOARD.md

      - name: Commit and Push Leaderboard
        if: github.event_name == 'push' && steps.eval_step.outputs.score != ''
        run: |
          git config user.name "Leaderboard Bot"
          git config user.email "actions@github.com"
          git add leaderboard/
          git commit -m "Update leaderboard for ${{ steps.eval_step.outputs.team_name }}" || exit 0
          git pull --rebase origin main
          git push origin HEAD:main